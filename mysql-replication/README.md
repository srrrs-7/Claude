# MySQL Master with 3 Read Replicas using SSL

このプロジェクトはDockerを使用してSSLで保護されたMySQL環境（マスター1台とSSL経由で接続する読み取りレプリカ3台）を構築します。

## セットアップ

1. .envファイルをMySQLのルートパスワードで作成します：
```
cp .env-example .env
# .envファイルを編集して希望のパスワードを設定
```

2. Makefileを使用して環境をセットアップし管理します：
```
make setup   # SSL付きレプリケーションを含む環境のセットアップ
make test    # レプリケーションが正しく動作しているかテスト
make fix     # 問題が発生した場合にレプリケーションを修復
```

## SSL設定

1. SSL証明書は自動的に生成されます。手動で生成したい場合は：
```
make ssl     # SSL証明書の生成と配置
```

2. SSL設定の検証：
```
make test    # 各スレーブでSSL接続の状態を確認
```

## トラブルシューティング

セットアップまたはテスト中に問題が発生した場合は、修復コマンドを実行できます：
```
make fix
```

それでも問題が解決しない場合は、完全なリセットを実行できます：
```
make reset
```

このコマンドは次の処理を行います：
1. すべてのスレーブでレプリケーションをリセットして再設定
2. 存在しない場合はテストデータベースとテーブルを作成
3. データが正しくレプリケートされていることを確認

## 接続情報

### マスター
- ポート: 3306
- ユーザー名: root
- パスワード: .envファイルで設定
- データベース: mydb

### リードレプリカ 1
- ポート: 3307
- ユーザー名: root
- パスワード: .envファイルで設定
- データベース: mydb

### リードレプリカ 2
- ポート: 3308
- ユーザー名: root
- パスワード: .envファイルで設定
- データベース: mydb

### リードレプリカ 3
- ポート: 3309
- ユーザー名: root
- パスワード: .envファイルで設定
- データベース: mydb

## その他のユーザー
- アプリケーションユーザー：
  - ユーザー名: myuser
  - パスワード: mypassword

- レプリケーションユーザー：
  - ユーザー名: repl
  - パスワード: repl_password
  - SSL接続が必須

## その他の便利なコマンド

```
make status     # すべてのコンテナの状態を表示
make logs       # すべてのコンテナからのログを表示
make logs-follow # リアルタイムでログをフォロー
make exec-master # マスターMySQLシェルに接続
make exec-slave1 # slave1 MySQLシェルに接続
make clean      # すべてのコンテナ、ボリューム、データを削除
```

## セキュリティ情報

- マスターとスレーブ間のすべての通信はSSLで暗号化されます
- レプリケーションユーザーはSSL接続のみを許可するように設定されています
- マスターでは`require_secure_transport = ON`が設定されており、すべての接続でSSLが必要です
